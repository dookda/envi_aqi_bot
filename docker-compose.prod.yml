# Production overrides for docker-compose.yml
# Optimized for Hetzner CX43: 8 vCPUs, 16GB RAM
# Usage: docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build

services:
  postgres:
    # Don't expose PostgreSQL port externally in production
    ports: []
    restart: always
    # Memory limit for PostgreSQL
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M

  api:
    # Only accessible from localhost (Nginx will proxy)
    ports:
      - "127.0.0.1:8000:8000"
    restart: always
    environment:
      - ENVIRONMENT=production
      - LOG_LEVEL=INFO
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M

  frontend:
    # Only accessible from localhost (Nginx will proxy)
    ports:
      - "127.0.0.1:5800:80"
    restart: always
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M

  scheduler:
    restart: always
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M

  ollama:
    restart: always
    # Ollama needs more memory for AI model inference
    # qwen2.5:1.5b uses ~1.5GB, allocate 8GB for headroom
    environment:
      - OLLAMA_MODEL=qwen2.5:1.5b
      - OLLAMA_NUM_PARALLEL=1
      - OLLAMA_MAX_LOADED_MODELS=1
    deploy:
      resources:
        limits:
          memory: 8G
        reservations:
          memory: 2G
    # Increase healthcheck timeout for production servers
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:11434/api/tags || exit 1" ]
      interval: 60s
      timeout: 30s
      retries: 10
      start_period: 300s

  data-prep:
    restart: always
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 64M
