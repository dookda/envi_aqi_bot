# Cloud Build CI/CD Pipeline
# Automatically builds and deploys on push to main branch
# 
# Setup: Connect your GitHub repo to Cloud Build
# https://console.cloud.google.com/cloud-build/triggers

steps:
  # Step 1: Build API image
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/aqi-app/api:${SHORT_SHA}'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/aqi-app/api:latest'
      - '.'
    id: 'build-api'

  # Step 2: Build Frontend image
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/aqi-app/frontend:${SHORT_SHA}'
      - '-t'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/aqi-app/frontend:latest'
      - '-f'
      - 'frontend/Dockerfile'
      - 'frontend'
    id: 'build-frontend'

  # Step 3: Push API image
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/aqi-app/api:${SHORT_SHA}'
    id: 'push-api'
    waitFor: ['build-api']

  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/aqi-app/api:latest'
    waitFor: ['build-api']

  # Step 4: Push Frontend image
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/aqi-app/frontend:${SHORT_SHA}'
    id: 'push-frontend'
    waitFor: ['build-frontend']

  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/aqi-app/frontend:latest'
    waitFor: ['build-frontend']

  # Step 5: Update Kubernetes deployments with new image
  - name: 'gcr.io/cloud-builders/gke-deploy'
    args:
      - 'run'
      - '--filename=deploy/gcp/kubernetes/'
      - '--location=${_ZONE}'
      - '--cluster=${_CLUSTER}'
    id: 'deploy'
    waitFor: ['push-api', 'push-frontend']

  # Step 6: Update API deployment image
  - name: 'gcr.io/cloud-builders/kubectl'
    args:
      - 'set'
      - 'image'
      - 'deployment/api'
      - 'api=${_REGION}-docker.pkg.dev/${PROJECT_ID}/aqi-app/api:${SHORT_SHA}'
      - '-n'
      - 'aqi-app'
    env:
      - 'CLOUDSDK_COMPUTE_ZONE=${_ZONE}'
      - 'CLOUDSDK_CONTAINER_CLUSTER=${_CLUSTER}'
    id: 'update-api-image'
    waitFor: ['deploy']

  # Step 7: Update Frontend deployment image
  - name: 'gcr.io/cloud-builders/kubectl'
    args:
      - 'set'
      - 'image'
      - 'deployment/frontend'
      - 'frontend=${_REGION}-docker.pkg.dev/${PROJECT_ID}/aqi-app/frontend:${SHORT_SHA}'
      - '-n'
      - 'aqi-app'
    env:
      - 'CLOUDSDK_COMPUTE_ZONE=${_ZONE}'
      - 'CLOUDSDK_CONTAINER_CLUSTER=${_CLUSTER}'
    id: 'update-frontend-image'
    waitFor: ['deploy']

# Substitutions (can be overridden)
substitutions:
  _REGION: 'asia-southeast1'
  _ZONE: 'asia-southeast1-b'
  _CLUSTER: 'aqi-cluster'

# Build options
options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'E2_HIGHCPU_8'

# Images to be pushed
images:
  - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/aqi-app/api:${SHORT_SHA}'
  - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/aqi-app/api:latest'
  - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/aqi-app/frontend:${SHORT_SHA}'
  - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/aqi-app/frontend:latest'

# Timeout for the entire build
timeout: '1800s'  # 30 minutes
